name: Linux RDP (Max Performance)

on:
  workflow_dispatch:

jobs:
  linux-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Maximize system performance
        run: |
          sudo swapoff -a
          sudo sysctl -w vm.swappiness=10
          sudo apt-get clean
          echo "Performance tuning complete"

      - name: Install GNOME + RDP
        run: |
          sudo apt update
          sudo apt install -y ubuntu-desktop xrdp dbus-x11 gnome-terminal
          sudo systemctl enable xrdp
          sudo adduser $USER ssl-cert
          sudo systemctl restart xrdp

          # Lightweight tweaks
          gsettings set org.gnome.desktop.session idle-delay 0 || true
          gsettings set org.gnome.desktop.screensaver lock-enabled false || true

      - name: Install Tailscale (Secure Access)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TS_AUTH_KEY }} \
                            --hostname=github-linux-max \
                            --accept-dns=false \
                            --ssh

      - name: System info
        run: |
          echo "===== SYSTEM INFO ====="
          lscpu | grep -E 'Model name|Socket|Thread|Core|CPU\(s\)'
          free -h
          df -h /
          echo "========================"

      - name: Display Access Info
        run: |
          echo "Tailscale node connected!"
          echo "Fetch IP via: https://login.tailscale.com/admin/machines"
          echo "Connect via RDP client (port 3389)"
          echo "Username: runner"
          echo "Password: runneradmin"
          echo "Desktop: GNOME"
