name: Linux GNOME via Tailscale

on:
  workflow_dispatch:

jobs:
  gnome-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Tailscale with SSH enabled
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TS_KEY }} --ssh --hostname="gnome-runner-${{ github.run_id }}"
          echo "✅ Connected to Tailscale!"
          tailscale ip -4

      - name: Install GNOME + VNC
        run: |
          sudo apt update
          sudo apt install -y gnome-session gnome-terminal tigervnc-standalone-server dbus-x11
          mkdir -p ~/.vnc
          echo "123456" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          echo "#!/bin/bash
          export XDG_SESSION_TYPE=x11
          export DISPLAY=:1
          gnome-session &" > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup
          vncserver :1 -geometry 1920x1080 -depth 24
          echo "✅ GNOME + VNC running on port 5901"

      - name: Keep alive for access
        run: sleep 10800
